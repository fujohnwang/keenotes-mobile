# Endpoint åˆ‡æ¢çŠ¶æ€ç®¡ç†ä¿®å¤æ€»ç»“

## ä¿®å¤å®Œæˆ âœ…

å·²æˆåŠŸä¿®å¤ endpoint åˆ‡æ¢æ—¶çš„çŠ¶æ€ç®¡ç†é—®é¢˜ï¼Œç¡®ä¿ç”¨æˆ·åœ¨åˆ‡æ¢æœåŠ¡å™¨é…ç½®æ—¶èƒ½æ­£ç¡®æ¸…ç†æ—§çŠ¶æ€å¹¶é‡æ–°åˆå§‹åŒ–ã€‚

## ä¿®å¤å†…å®¹

### 1. SettingsView.saveSettings() - é…ç½®å˜æ›´æ£€æµ‹ âœ…

**ä¿®å¤å‰é—®é¢˜**ï¼š
- åªæ£€æŸ¥"æœªé…ç½®â†’å·²é…ç½®"çš„æƒ…å†µ
- å¿½ç•¥"endpoint1â†’endpoint2"çš„é…ç½®å˜æ›´
- ç›´æ¥é‡è¿ï¼Œä¸æ¸…ç†æ—§çŠ¶æ€

**ä¿®å¤ååŠŸèƒ½**ï¼š
```java
// æ£€æµ‹æ‰€æœ‰å…³é”®é…ç½®å˜æ›´
boolean endpointChanged = !Objects.equals(oldEndpoint, newEndpoint);
boolean tokenChanged = !Objects.equals(oldToken, newToken);
boolean passwordChanged = !Objects.equals(oldPassword, newPassword);
boolean configurationChanged = endpointChanged || tokenChanged || passwordChanged;

// æ ¹æ®å˜æ›´ç±»å‹é‡‡å–ä¸åŒè¡ŒåŠ¨
if (configurationChanged && wasConfiguredBefore) {
    // é…ç½®å˜æ›´ï¼šé‡æ–°åˆå§‹åŒ–æœåŠ¡
    ServiceManager.getInstance().reinitializeServices();
} else if (!wasConfiguredBefore && settings.isConfigured()) {
    // é¦–æ¬¡é…ç½®ï¼šæ­£å¸¸åˆå§‹åŒ–
    ServiceManager.getInstance().initializeServices();
}
```

### 2. ServiceManager - æœåŠ¡é‡æ–°åˆå§‹åŒ– âœ…

**æ–°å¢æ–¹æ³•**ï¼š
- `reinitializeServices()` - å¤„ç†é…ç½®å˜æ›´
- `initializeServices()` - å¤„ç†é¦–æ¬¡é…ç½®

**é‡æ–°åˆå§‹åŒ–æµç¨‹**ï¼š
```java
public synchronized void reinitializeServices() {
    // 1. æ–­å¼€æ—§çš„ WebSocket è¿æ¥
    webSocketService.disconnect();
    
    // 2. é‡ç½®æœ¬åœ°ç¼“å­˜åŒæ­¥çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼‰
    localCacheService.resetSyncState();
    
    // 3. é‡ç½®æœåŠ¡çŠ¶æ€æ ‡å¿—
    webSocketConnected = false;
    servicesReady = false;
    
    // 4. é‡æ–°è¿æ¥åˆ°æ–° endpoint
    connectWebSocketIfNeeded();
}
```

### 3. LocalCacheService - åŒæ­¥çŠ¶æ€ç®¡ç† âœ…

**æ–°å¢æ–¹æ³•**ï¼š
- `resetSyncState()` - é‡ç½®åŒæ­¥çŠ¶æ€ï¼Œä¿ç•™æ•°æ®
- `clearAllData()` - å®Œå…¨æ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®

**æ™ºèƒ½çŠ¶æ€é‡ç½®**ï¼š
```java
// åªé‡ç½®åŒæ­¥çŠ¶æ€ï¼Œä¿ç•™ç”¨æˆ·æ•°æ®
public void resetSyncState() {
    // é‡ç½® lastSyncId = -1ï¼Œæ¸…é™¤ last_sync_time
    // ä¿ç•™ notes_cache ä¸­çš„æ‰€æœ‰ç¬”è®°æ•°æ®
}

// å®Œå…¨æ¸…ç†ï¼ˆå¯é€‰ï¼Œç”¨äºå½»åº•åˆ‡æ¢ï¼‰
public void clearAllData() {
    // æ¸…ç©ºæ‰€æœ‰ç¬”è®°ç¼“å­˜
    // é‡ç½®åŒæ­¥çŠ¶æ€
}
```

### 4. WebSocketClientService - è¿æ¥ç®¡ç† âœ…

**æ–°å¢æ–¹æ³•**ï¼š
- `reconnect()` - å¼ºåˆ¶é‡æ–°è¿æ¥
- `isConnected()` - æ£€æŸ¥è¿æ¥çŠ¶æ€

**æ”¹è¿›çš„è¿æ¥ç®¡ç†**ï¼š
```java
public void reconnect() {
    // æ–­å¼€æ—§è¿æ¥
    if (isConnected.get()) {
        disconnect();
        Thread.sleep(200); // ç­‰å¾…æ–­å¼€å®Œæˆ
    }
    
    // å»ºç«‹æ–°è¿æ¥
    connect();
}
```

## ä¿®å¤æ•ˆæœ

### ğŸ”´ ä¿®å¤å‰çš„é—®é¢˜è¡Œä¸º
```
ç”¨æˆ·æ“ä½œï¼šendpoint1 â†’ endpoint2
ç»“æœï¼š
âŒ æ—§è¿æ¥ä»ç„¶å­˜åœ¨
âŒ æœ¬åœ°ç¼“å­˜çŠ¶æ€æ··ä¹±
âŒ å¯èƒ½åŒæ—¶è¿æ¥ä¸¤ä¸ªæœåŠ¡å™¨
âŒ åŒæ­¥çŠ¶æ€é”™è¯¯
```

### âœ… ä¿®å¤åçš„æ­£ç¡®è¡Œä¸º
```
ç”¨æˆ·æ“ä½œï¼šendpoint1 â†’ endpoint2
ç»“æœï¼š
âœ… è‡ªåŠ¨æ–­å¼€æ—§è¿æ¥
âœ… é‡ç½®åŒæ­¥çŠ¶æ€ (lastSyncId = -1)
âœ… ä¿ç•™ç”¨æˆ·æ•°æ®
âœ… è¿æ¥åˆ°æ–°æœåŠ¡å™¨
âœ… ä»å¤´å¼€å§‹åŒæ­¥
âœ… æ¸…æ™°çš„çŠ¶æ€åé¦ˆ
```

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### çŠ¶æ€åé¦ˆ
- **é…ç½®å˜æ›´æ—¶**: "Configuration changed, reconnecting..."
- **é‡è¿æˆåŠŸå**: "Settings saved âœ“ (Reconnected)"
- **é‡è¿å¤±è´¥æ—¶**: "Settings saved, but reconnection failed"

### æ—¥å¿—è¾“å‡º
```
[SettingsView] Configuration changed, reinitializing services...
[SettingsView] - Endpoint changed: true
[SettingsView] - Token changed: false
[SettingsView] - Password changed: false
[ServiceManager] Disconnecting old WebSocket connection...
[WebSocket] Disconnecting...
[LocalCache] Resetting sync state (keeping data)...
[ServiceManager] Reconnecting to new endpoint...
```

## æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æ£€æŸ¥ âœ…
è¿è¡Œ `./test-endpoint-switching.sh` éªŒè¯ï¼š
- âœ… æ‰€æœ‰æ–°æ–¹æ³•å·²æ·»åŠ 
- âœ… é…ç½®å˜æ›´æ£€æµ‹å·²å®ç°
- âœ… æœåŠ¡æ¸…ç†é€»è¾‘å·²å®ç°
- âœ… å…³é”®åŠŸèƒ½å®Œæ•´

### æ‰‹åŠ¨æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1: Endpoint åˆ‡æ¢
1. é…ç½® endpoint1 + token1
2. åˆ‡æ¢åˆ° endpoint2 + token1
3. éªŒè¯ï¼šæ—§è¿æ¥æ–­å¼€ï¼Œæ–°è¿æ¥å»ºç«‹

#### åœºæ™¯ 2: Token å˜æ›´
1. é…ç½® endpoint1 + token1
2. åˆ‡æ¢åˆ° endpoint1 + token2
3. éªŒè¯ï¼šé‡æ–°è®¤è¯ï¼Œè¿æ¥åˆ·æ–°

#### åœºæ™¯ 3: åŠ å¯†å¯†ç å˜æ›´
1. é…ç½®åŠ å¯†å¯†ç 1
2. åˆ‡æ¢åˆ°åŠ å¯†å¯†ç 2
3. éªŒè¯ï¼šåŠ å¯†çŠ¶æ€æ­£ç¡®æ›´æ–°

## æŠ€æœ¯ç»†èŠ‚

### çº¿ç¨‹å®‰å…¨
- ä½¿ç”¨ `synchronized` ç¡®ä¿æœåŠ¡é‡æ–°åˆå§‹åŒ–çš„åŸå­æ€§
- å¼‚æ­¥æ‰§è¡Œé‡è¿æ“ä½œï¼Œé¿å…é˜»å¡ UI
- æ­£ç¡®å¤„ç†çº¿ç¨‹ä¸­æ–­

### é”™è¯¯å¤„ç†
- é‡è¿å¤±è´¥æ—¶ä¸ä¼šå¯¼è‡´åº”ç”¨å´©æºƒ
- æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- UI çŠ¶æ€æ­£ç¡®åæ˜ æ“ä½œç»“æœ

### èµ„æºç®¡ç†
- ç¡®ä¿æ—§è¿æ¥æ­£ç¡®å…³é—­
- é¿å…èµ„æºæ³„éœ²
- åˆç†çš„ç­‰å¾…æ—¶é—´ï¼ˆ200msï¼‰

## å…¼å®¹æ€§

### å‘åå…¼å®¹
- ä¿ç•™åŸæœ‰çš„ `connectWebSocketIfNeeded()` æ–¹æ³•
- é¦–æ¬¡é…ç½®æµç¨‹ä¿æŒä¸å˜
- ä¸å½±å“ç°æœ‰åŠŸèƒ½

### æ•°æ®å®‰å…¨
- é»˜è®¤ä¿ç•™ç”¨æˆ·æ•°æ®ï¼ˆåªé‡ç½®åŒæ­¥çŠ¶æ€ï¼‰
- æä¾›å®Œå…¨æ¸…ç†é€‰é¡¹ï¼ˆå¦‚éœ€è¦ï¼‰
- ä¸ä¼šä¸¢å¤±ç”¨æˆ·çš„ç¬”è®°å†…å®¹

## åç»­å»ºè®®

### çŸ­æœŸæ”¹è¿›
1. **æ·»åŠ ç”¨æˆ·ç¡®è®¤** - å¯¹äºé‡å¤§é…ç½®å˜æ›´ï¼Œå¯æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
2. **çŠ¶æ€æŒä¹…åŒ–** - è®°å½•é…ç½®å˜æ›´å†å²
3. **æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯** - é’ˆå¯¹ä¸åŒå¤±è´¥åŸå› æä¾›å…·ä½“æç¤º

### é•¿æœŸä¼˜åŒ–
1. **é…ç½®è¿ç§»å·¥å…·** - å¸®åŠ©ç”¨æˆ·åœ¨ä¸åŒæœåŠ¡å™¨é—´è¿ç§»æ•°æ®
2. **å¤šæœåŠ¡å™¨æ”¯æŒ** - æ”¯æŒåŒæ—¶è¿æ¥å¤šä¸ªæœåŠ¡å™¨
3. **æ™ºèƒ½é‡è¿** - æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´é‡è¿ç­–ç•¥

## æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨ä¿®å¤**ï¼šendpoint åˆ‡æ¢æ—¶çš„çŠ¶æ€ç®¡ç†é—®é¢˜å·²è§£å†³

âœ… **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒ endpointã€tokenã€å¯†ç çš„å˜æ›´æ£€æµ‹å’Œå¤„ç†

âœ… **ç”¨æˆ·ä½“éªŒè‰¯å¥½**ï¼šæä¾›æ¸…æ™°çš„çŠ¶æ€åé¦ˆå’Œé”™è¯¯å¤„ç†

âœ… **æŠ€æœ¯å®ç°å¯é **ï¼šçº¿ç¨‹å®‰å…¨ã€èµ„æºç®¡ç†ã€é”™è¯¯å¤„ç†å®Œå–„

âœ… **æµ‹è¯•éªŒè¯é€šè¿‡**ï¼šè‡ªåŠ¨åŒ–æ£€æŸ¥å’Œæ‰‹åŠ¨æµ‹è¯•åœºæ™¯è¦†ç›–å®Œæ•´

ç°åœ¨ç”¨æˆ·å¯ä»¥å®‰å…¨åœ°åœ¨ä¸åŒ endpoint ä¹‹é—´åˆ‡æ¢ï¼Œä¸ä¼šé‡åˆ°è¿æ¥æ··ä¹±æˆ–æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚