name: Release

on:
  push:
    tags:
      - 'v*'
      - 'V*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR
        shell: bash
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=win"

      - name: Create Windows EXE Installer
        shell: pwsh
        run: |
          jpackage `
            --input target `
            --name KeeNotes `
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar `
            --main-class org.springframework.boot.loader.launch.JarLauncher `
            --type exe `
            --app-version ${{ steps.version.outputs.version }} `
            --vendor "Keevol" `
            --icon "src/main/resources/icons/app-icon.ico" `
            --java-options "-Xmx512m" `
            --win-shortcut `
            --win-menu `
            --win-menu-group "Keevol" `
            --win-dir-chooser `
            --dest dist

      - name: Create Windows MSI Installer
        shell: pwsh
        run: |
          jpackage `
            --input target `
            --name KeeNotes `
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar `
            --main-class org.springframework.boot.loader.launch.JarLauncher `
            --type msi `
            --app-version ${{ steps.version.outputs.version }} `
            --vendor "Keevol" `
            --icon "src/main/resources/icons/app-icon.ico" `
            --java-options "-Xmx512m" `
            --win-shortcut `
            --win-menu `
            --win-menu-group "Keevol" `
            --win-dir-chooser `
            --dest dist

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: dist/*

  build-macos:
    strategy:
      matrix:
        include:
          - arch: mac
            name-suffix: Intel
            runner: macos-15-intel
          - arch: mac-aarch64
            name-suffix: AppleSilicon
            runner: macos-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR for ${{ matrix.arch }}
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=${{ matrix.arch }}"

      - name: Create macOS DMG
        run: |
          jpackage \
            --input target \
            --name "KeeNotes" \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type dmg \
            --app-version ${{ steps.version.outputs.version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/keenotes.icns" \
            --mac-package-identifier "cn.keevol.keenotes" \
            --mac-package-name "KeeNotes" \
            --java-options "-Xmx512m" \
            --java-options "-Xdock:name=KeeNotes" \
            --dest dist
          # Rename DMG to include platform suffix
          mv dist/KeeNotes-${{ steps.version.outputs.version }}.dmg dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: dist/*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=linux"

      - name: Create DEB Package
        run: |
          jpackage \
            --input target \
            --name keenotes \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type deb \
            --app-version ${{ steps.version.outputs.version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/icon-512.png" \
            --java-options "-Xmx512m" \
            --linux-shortcut \
            --dest dist

      - name: Create RPM Package
        run: |
          jpackage \
            --input target \
            --name keenotes \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type rpm \
            --app-version ${{ steps.version.outputs.version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/icon-512.png" \
            --java-options "-Xmx512m" \
            --linux-shortcut \
            --dest dist

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: dist/*

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Generate versionCode from version (e.g., 1.2.3 -> 10203)
          VERSION_CODE=$(echo $VERSION | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.4'

      - name: Build Release APK
        working-directory: keenotes-android
        run: gradle assembleRelease --no-daemon -PversionName=${{ steps.version.outputs.version }} -PversionCode=${{ steps.version.outputs.versionCode }}

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: keenotes-android/app/build/outputs/apk/release/*.apk

  release:
    needs: [build-windows, build-macos, build-linux, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: KeeNotes ${{ env.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          generate_release_notes: true
          files: |
            artifacts/windows-installers/*
            artifacts/macos-mac/*
            artifacts/macos-mac-aarch64/*
            artifacts/linux-packages/*
            artifacts/android-apk/*
