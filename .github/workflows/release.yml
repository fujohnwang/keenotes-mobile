name: Release

on:
  push:
    tags:
      - 'v*'
      - 'V*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # jpackage only supports up to 3 version segments (x.y.z)
          APP_VERSION=$(echo $VERSION | cut -d. -f1-3)
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR
        shell: bash
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=win"

      - name: Create Windows EXE Installer
        shell: pwsh
        run: |
          jpackage `
            --input target `
            --name KeeNotes `
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar `
            --main-class org.springframework.boot.loader.launch.JarLauncher `
            --type exe `
            --app-version ${{ steps.version.outputs.app_version }} `
            --vendor "Keevol" `
            --icon "src/main/resources/icons/app-icon.ico" `
            --java-options "-Xmx512m" `
            --win-shortcut `
            --win-menu `
            --win-menu-group "Keevol" `
            --win-dir-chooser `
            --dest dist

      - name: Create Windows MSI Installer
        shell: pwsh
        run: |
          jpackage `
            --input target `
            --name KeeNotes `
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar `
            --main-class org.springframework.boot.loader.launch.JarLauncher `
            --type msi `
            --app-version ${{ steps.version.outputs.app_version }} `
            --vendor "Keevol" `
            --icon "src/main/resources/icons/app-icon.ico" `
            --java-options "-Xmx512m" `
            --win-shortcut `
            --win-menu `
            --win-menu-group "Keevol" `
            --win-dir-chooser `
            --dest dist

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: dist/*

      - name: Release to Public Repo
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          path: dist/*
          repository: fujohnwang/keenotes-releases
          token: ${{ secrets.RELEASE_TOKEN }} # 使用上面配置的Token
          tag_name: ${{ github.ref_name }} # 同步Tag名称


  build-macos:
    strategy:
      matrix:
        include:
          - arch: mac
            name-suffix: Intel
            runner: macos-15-intel
          - arch: mac-aarch64
            name-suffix: AppleSilicon
            runner: macos-latest
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # jpackage only supports up to 3 version segments (x.y.z)
          APP_VERSION=$(echo $VERSION | cut -d. -f1-3)
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR for ${{ matrix.arch }}
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=${{ matrix.arch }}"

      # Import signing certificates
      - name: Import Code Signing Certificates
        id: import-certs
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          MACOS_INSTALLER_CERTIFICATE: ${{ secrets.MACOS_INSTALLER_CERTIFICATE }}
          MACOS_INSTALLER_CERTIFICATE_PWD: ${{ secrets.MACOS_INSTALLER_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import application signing certificate (Developer ID Application)
          echo "$MACOS_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -k $KEYCHAIN_PATH \
            -P "$MACOS_CERTIFICATE_PWD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          
          # Import installer signing certificate (Developer ID Installer)
          echo "$MACOS_INSTALLER_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/installer_certificate.p12
          security import $RUNNER_TEMP/installer_certificate.p12 \
            -k $KEYCHAIN_PATH \
            -P "$MACOS_INSTALLER_CERTIFICATE_PWD" \
            -T /usr/bin/productsign \
            -T /usr/bin/security
          
          # Set keychain as default and allow codesign to access it
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Verify certificates
          echo "Available signing identities:"
          security find-identity -v -p codesigning $KEYCHAIN_PATH
          security find-identity -v -p basic $KEYCHAIN_PATH

      - name: Create Signed macOS App Bundle
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          # ==========================================
          # 1. 准备 Entitlements
          # ==========================================
          cat > entitlements.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
          </dict>
          </plist>
          EOF

          # ==========================================
          # 2. 生成 App Image
          # ==========================================
          if [ "${{ matrix.arch }}" = "mac-aarch64" ]; then
            SQLITE_ARCH="aarch64"
          else
            SQLITE_ARCH="x86_64"
          fi
          
          jpackage \
            --input target \
            --name "KeeNotes" \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type app-image \
            --app-version ${{ steps.version.outputs.app_version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/keenotes.icns" \
            --mac-package-identifier "cn.keevol.keenotes" \
            --mac-package-name "KeeNotes" \
            --java-options "-Xmx512m" \
            --java-options "-Xdock:name=KeeNotes" \
            --java-options "-Dorg.sqlite.lib.path=\$APPDIR/../Frameworks" \
            --dest dist
          
          APP_PATH="dist/KeeNotes.app"
          FRAMEWORKS_DIR="$APP_PATH/Contents/Frameworks"
          mkdir -p "$FRAMEWORKS_DIR"
          
          echo "=== Processing Native Libraries ==="
          
          # 获取 Main Jar 的绝对路径
          MAIN_JAR="$(pwd)/$APP_PATH/Contents/app/keenotes-mobile-1.0.0-SNAPSHOT.jar"
          echo "Processing Main JAR: $MAIN_JAR"
          
          # 1. 提取 sqlite jar 到临时文件
          unzip -p "$MAIN_JAR" "BOOT-INF/lib/sqlite-jdbc-*.jar" > sqlite-temp.jar
          
          if [ -s sqlite-temp.jar ]; then
             echo "Found SQLite JDBC jar."
             
             # 2. 提取 dylib 到 Frameworks (供 App 运行时加载)
             unzip -p sqlite-temp.jar "org/sqlite/native/Mac/$SQLITE_ARCH/libsqlitejdbc.dylib" > "$FRAMEWORKS_DIR/libsqlitejdbc.dylib"
             
             if [ -s "$FRAMEWORKS_DIR/libsqlitejdbc.dylib" ]; then
                echo "  ✓ Extracted libsqlitejdbc.dylib to Frameworks"
                
                # 3. 【关键】从 sqlite-temp.jar 中彻底删除 Mac native 库
                # 这一步是为了满足 Apple 公证，因为它们在 jar 里没法签名
                echo "  Stripping unsigned binaries from sqlite-temp.jar..."
                zip -d sqlite-temp.jar "org/sqlite/native/Mac/*" 2>/dev/null || true
                
                # 4. 【核心修复】将处理干净的 jar 塞回 Main Jar
                # 必须使用 zip -0 (无压缩模式) 更新，否则 Spring Boot 启动会报错
                SQLITE_INTERNAL_PATH=$(unzip -l "$MAIN_JAR" | grep "sqlite-jdbc-.*\.jar" | awk '{print $4}')
                echo "  Updating $SQLITE_INTERNAL_PATH inside Main JAR..."
                
                # 创建对应的目录结构以便 zip 更新
                TEMP_UPDATE_DIR="update_tmp"
                mkdir -p "$TEMP_UPDATE_DIR/$(dirname "$SQLITE_INTERNAL_PATH")"
                mv sqlite-temp.jar "$TEMP_UPDATE_DIR/$SQLITE_INTERNAL_PATH"
                
                # 进入临时目录执行更新
                cd "$TEMP_UPDATE_DIR"
                # -u: 更新, -0: 仅存储(不压缩) -> 这解决了 ClassNotFoundException
                zip -0 -u "$MAIN_JAR" "$SQLITE_INTERNAL_PATH"
                cd ..
                rm -rf "$TEMP_UPDATE_DIR"
                
                echo "  ✓ Successfully patched Main JAR (Store mode)"
             else
                echo "  ⚠ Failed to extract dylib (Architecture mismatch?)"
             fi
          else
             echo "  ⚠ SQLite JDBC jar not found inside Main JAR"
          fi

          # ==========================================
          # 3. 签名流程
          # ==========================================
          echo "=== Signing Binaries ==="
          
          # [关键] 修复 libjli.dylib 软链接
          JLI_REAL="$APP_PATH/Contents/runtime/Contents/Home/lib/libjli.dylib"
          JLI_LINK="$APP_PATH/Contents/runtime/Contents/MacOS/libjli.dylib"
          if [ -f "$JLI_LINK" ]; then
            rm "$JLI_LINK"
            ln -s "../Home/lib/libjli.dylib" "$JLI_LINK"
            echo "  ✓ Fixed libjli.dylib symlink"
          fi
          
          # 1. 签名 Frameworks (刚才提取出来的 sqlite)
          if [ -f "$FRAMEWORKS_DIR/libsqlitejdbc.dylib" ]; then
             codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime "$FRAMEWORKS_DIR/libsqlitejdbc.dylib"
          fi
          
          # 2. 签名所有 dylib/jnilib (排除 Frameworks)
          find "$APP_PATH/Contents" -type f \( -name "*.dylib" -o -name "*.jnilib" \) | while read lib; do
             if [[ "$lib" != *"/Frameworks/"* ]]; then
                 echo "Signing lib: $(basename $lib)"
                 codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime "$lib"
             fi
          done
          
          # 3. 签名 JRE 可执行文件
          find "$APP_PATH/Contents/runtime" -type f -perm +111 | while read exe; do
             if file "$exe" | grep -q "Mach-O"; then
                echo "Signing exe: $(basename $exe)"
                codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$exe"
             fi
          done
          
          # 4. 签名主程序和 App Bundle
          echo "Signing Main Executable..."
          codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$APP_PATH/Contents/MacOS/KeeNotes"
          
          echo "Signing App Bundle..."
          codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$APP_PATH"
          
          # 验证
          codesign -vvv --deep --strict "$APP_PATH"

      - name: Create Signed macOS DMG
        run: |
          VOLNAME="KeeNotes"
          DMG_TEMP="dist/KeeNotes-temp.dmg"
          DMG_FINAL="dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg"
          
          hdiutil create -volname "$VOLNAME" -srcfolder dist/KeeNotes.app -ov -format UDZO "$DMG_TEMP"
          
          echo "Signing DMG..."
          codesign --force --sign "${{ secrets.MACOS_SIGNING_IDENTITY }}" --timestamp "$DMG_TEMP"
          
          mv "$DMG_TEMP" "$DMG_FINAL"
          codesign -vvv "$DMG_FINAL"

      # Notarize DMG (保持不变)
      - name: Notarize DMG
        id: notarize-dmg
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
          APPLE_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
        run: |
          echo "Submitting DMG for notarization..."
          SUBMISSION_OUTPUT=$(xcrun notarytool submit dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --timeout 30m \
            --output-format json)
          
          echo "$SUBMISSION_OUTPUT"
          
          STATUS=$(echo "$SUBMISSION_OUTPUT" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
          if [ "$STATUS" = "Accepted" ]; then
            echo "✅ Notarization successful!"
            xcrun stapler staple dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg
            echo "notarized=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Notarization failed with status: $STATUS"
            exit 1
          fi

      # - name: Create Signed macOS App Bundle
      #   env:
      #     MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
      #   run: |
      #     # ==========================================
      #     # 1. 准备 Entitlements (必须!)
      #     # ==========================================
      #     cat > entitlements.plist <<EOF
      #     <?xml version="1.0" encoding="UTF-8"?>
      #     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      #     <plist version="1.0">
      #     <dict>
      #         <key>com.apple.security.cs.allow-jit</key>
      #         <true/>
      #         <key>com.apple.security.cs.disable-library-validation</key>
      #         <true/>
      #     </dict>
      #     </plist>
      #     EOF

      #     # ==========================================
      #     # 2. 生成 App Image
      #     # ==========================================
      #     if [ "${{ matrix.arch }}" = "mac-aarch64" ]; then
      #       SQLITE_ARCH="aarch64"
      #     else
      #       SQLITE_ARCH="x86_64"
      #     fi
          
      #     # jpackage 命令
      #     # -Dorg.sqlite.lib.path 告诉 SQLite 优先去 Frameworks 找库
      #     jpackage \
      #       --input target \
      #       --name "KeeNotes" \
      #       --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
      #       --main-class org.springframework.boot.loader.launch.JarLauncher \
      #       --type app-image \
      #       --app-version ${{ steps.version.outputs.app_version }} \
      #       --vendor "Keevol" \
      #       --icon "src/main/resources/icons/keenotes.icns" \
      #       --mac-package-identifier "cn.keevol.keenotes" \
      #       --mac-package-name "KeeNotes" \
      #       --java-options "-Xmx512m" \
      #       --java-options "-Xdock:name=KeeNotes" \
      #       --java-options "-Dorg.sqlite.lib.path=\$APPDIR/../Frameworks" \
      #       --dest dist
          
      #     APP_PATH="dist/KeeNotes.app"
      #     FRAMEWORKS_DIR="$APP_PATH/Contents/Frameworks"
      #     mkdir -p "$FRAMEWORKS_DIR"
          
      #     # ==========================================
      #     # 3. 提取 Native Libraries (只提取，不修改 Jar)
      #     # ==========================================
      #     echo "=== Extracting Native Libraries to Frameworks ==="
          
      #     MAIN_JAR="$APP_PATH/Contents/app/keenotes-mobile-1.0.0-SNAPSHOT.jar"
          
      #     # 使用 unzip 管道提取，不解压整个 Jar，保证 Main Jar 完好无损
      #     # 1. 从 Main Jar 提取 sqlite jar 到 stdout -> 写入 temp jar
      #     unzip -p "$MAIN_JAR" "BOOT-INF/lib/sqlite-jdbc-*.jar" > sqlite-temp.jar
          
      #     if [ -s sqlite-temp.jar ]; then
      #        echo "Found SQLite JDBC jar, extracting dylib..."
      #        # 2. 从 temp jar 提取 dylib 到 Frameworks
      #        unzip -p sqlite-temp.jar "org/sqlite/native/Mac/$SQLITE_ARCH/libsqlitejdbc.dylib" > "$FRAMEWORKS_DIR/libsqlitejdbc.dylib"
             
      #        if [ -s "$FRAMEWORKS_DIR/libsqlitejdbc.dylib" ]; then
      #           echo "  ✓ Extracted libsqlitejdbc.dylib to Frameworks"
      #        else
      #           echo "  ⚠ Failed to extract dylib from sqlite jar"
      #        fi
      #        rm sqlite-temp.jar
      #     else
      #        echo "  ⚠ SQLite JDBC jar not found in BOOT-INF/lib"
      #     fi

      #     # ==========================================
      #     # 4. 签名流程
      #     # ==========================================
      #     echo "=== Signing Binaries ==="
          
      #     # [关键步骤] 修复 libjli.dylib 结构，防止 Notarization 失败
      #     JLI_REAL="$APP_PATH/Contents/runtime/Contents/Home/lib/libjli.dylib"
      #     JLI_LINK="$APP_PATH/Contents/runtime/Contents/MacOS/libjli.dylib"
          
      #     if [ -f "$JLI_LINK" ]; then
      #       echo "Fixing libjli.dylib structure..."
      #       rm "$JLI_LINK"
      #       ln -s "../Home/lib/libjli.dylib" "$JLI_LINK"
      #       echo "  ✓ Replaced MacOS/libjli.dylib with symlink"
      #     fi
          
      #     # 1. 签名 Frameworks (刚才提取出来的 sqlite)
      #     if [ -f "$FRAMEWORKS_DIR/libsqlitejdbc.dylib" ]; then
      #        codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime "$FRAMEWORKS_DIR/libsqlitejdbc.dylib"
      #     fi
          
      #     # 2. 签名 App 内的所有 .dylib 和 .jnilib (JRE 自带的)
      #     # 使用 -type f 忽略我们刚才建立的软链接
      #     find "$APP_PATH/Contents" -type f \( -name "*.dylib" -o -name "*.jnilib" \) | while read lib; do
      #        if [[ "$lib" != *"/Frameworks/"* ]]; then
      #            echo "Signing lib: $(basename $lib)"
      #            codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime "$lib"
      #        fi
      #     done
          
      #     # 3. 签名 JRE 的可执行文件
      #     find "$APP_PATH/Contents/runtime" -type f -perm +111 | while read exe; do
      #        if file "$exe" | grep -q "Mach-O"; then
      #           echo "Signing exe: $(basename $exe)"
      #           codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$exe"
      #        fi
      #     done
          
      #     # 4. 签名主启动器
      #     echo "Signing Main Executable..."
      #     codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$APP_PATH/Contents/MacOS/KeeNotes"
          
      #     # 5. 签名整个 App Bundle (不加 --deep)
      #     echo "Signing App Bundle..."
      #     codesign --force --sign "$MACOS_SIGNING_IDENTITY" --timestamp --options runtime --entitlements entitlements.plist "$APP_PATH"
          
      #     # 验证
      #     codesign -vvv --deep --strict "$APP_PATH"

      # - name: Create Signed macOS DMG
      #   run: |
      #     VOLNAME="KeeNotes"
      #     DMG_TEMP="dist/KeeNotes-temp.dmg"
      #     DMG_FINAL="dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg"
          
      #     # 创建 DMG
      #     hdiutil create -volname "$VOLNAME" -srcfolder dist/KeeNotes.app -ov -format UDZO "$DMG_TEMP"
          
      #     # 签名 DMG (Notarization 需要)
      #     echo "Signing DMG..."
      #     codesign --force --sign "${{ secrets.MACOS_SIGNING_IDENTITY }}" --timestamp "$DMG_TEMP"
          
      #     mv "$DMG_TEMP" "$DMG_FINAL"
      #     codesign -vvv "$DMG_FINAL"

      # # Notarize DMG
      # - name: Notarize DMG
      #   id: notarize-dmg
      #   env:
      #     APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
      #     APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
      #     APPLE_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
      #   run: |
      #     echo "Submitting DMG for notarization..."
          
      #     # Submit for notarization
      #     SUBMISSION_OUTPUT=$(xcrun notarytool submit dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg \
      #       --apple-id "$APPLE_ID" \
      #       --password "$APPLE_PASSWORD" \
      #       --team-id "$APPLE_TEAM_ID" \
      #       --wait \
      #       --timeout 30m \
      #       --output-format json)
          
      #     echo "$SUBMISSION_OUTPUT"
          
      #     # Check if notarization was successful
      #     STATUS=$(echo "$SUBMISSION_OUTPUT" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
      #     if [ "$STATUS" = "Accepted" ]; then
      #       echo "✅ Notarization successful!"
            
      #       # Staple the notarization ticket to the DMG
      #       echo "Stapling notarization ticket..."
      #       xcrun stapler staple dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg
            
      #       # Verify stapling
      #       xcrun stapler validate dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg
            
      #       # Final verification with spctl (should pass now after notarization)
      #       echo "Verifying Gatekeeper acceptance..."
      #       hdiutil attach dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.dmg -nobrowse -mountpoint /Volumes/KeeNotes
      #       spctl -a -vvv -t install /Volumes/KeeNotes/KeeNotes.app
      #       hdiutil detach /Volumes/KeeNotes
            
      #       echo "notarized=true" >> $GITHUB_OUTPUT
      #     else
      #       echo "❌ Notarization failed with status: $STATUS"
            
      #       # Get submission ID for debugging
      #       SUBMISSION_ID=$(echo "$SUBMISSION_OUTPUT" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
      #       if [ -n "$SUBMISSION_ID" ]; then
      #         echo "Fetching notarization log..."
      #         xcrun notarytool log "$SUBMISSION_ID" \
      #           --apple-id "$APPLE_ID" \
      #           --password "$APPLE_PASSWORD" \
      #           --team-id "$APPLE_TEAM_ID"
      #       fi
            
      #       exit 1
      #     fi

      # - name: Create Signed macOS PKG
      #   env:
      #     MACOS_INSTALLER_IDENTITY: ${{ secrets.MACOS_INSTALLER_IDENTITY }}
      #   run: |
      #     # Create PKG from the already signed app bundle
      #     jpackage \
      #       --app-image dist/KeeNotes.app \
      #       --name "KeeNotes" \
      #       --type pkg \
      #       --app-version ${{ steps.version.outputs.app_version }} \
      #       --vendor "Keevol" \
      #       --mac-package-identifier "cn.keevol.keenotes" \
      #       --mac-package-name "KeeNotes" \
      #       --mac-sign \
      #       --mac-signing-key-user-name "$MACOS_INSTALLER_IDENTITY" \
      #       --dest dist
          
      #     # Rename PKG to include platform suffix
      #     mv dist/KeeNotes-${{ steps.version.outputs.app_version }}.pkg dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg
          
      #     # Verify PKG signature
      #     echo "Verifying PKG signature..."
      #     pkgutil --check-signature dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg

      # # Notarize PKG
      # - name: Notarize PKG
      #   id: notarize-pkg
      #   env:
      #     APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
      #     APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
      #     APPLE_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
      #   run: |
      #     echo "Submitting PKG for notarization..."
          
      #     # Submit for notarization
      #     SUBMISSION_OUTPUT=$(xcrun notarytool submit dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg \
      #       --apple-id "$APPLE_ID" \
      #       --password "$APPLE_PASSWORD" \
      #       --team-id "$APPLE_TEAM_ID" \
      #       --wait \
      #       --timeout 30m \
      #       --output-format json)
          
      #     echo "$SUBMISSION_OUTPUT"
          
      #     # Check if notarization was successful
      #     STATUS=$(echo "$SUBMISSION_OUTPUT" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          
      #     if [ "$STATUS" = "Accepted" ]; then
      #       echo "✅ Notarization successful!"
            
      #       # Staple the notarization ticket to the PKG
      #       echo "Stapling notarization ticket..."
      #       xcrun stapler staple dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg
            
      #       # Verify stapling
      #       xcrun stapler validate dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg
            
      #       # Final verification with spctl
      #       echo "Verifying Gatekeeper acceptance..."
      #       spctl -a -vvv -t install dist/KeeNotes-${{ matrix.name-suffix }}-${{ steps.version.outputs.version }}.pkg
            
      #       echo "notarized=true" >> $GITHUB_OUTPUT
      #     else
      #       echo "❌ Notarization failed with status: $STATUS"
            
      #       # Get submission ID for debugging
      #       SUBMISSION_ID=$(echo "$SUBMISSION_OUTPUT" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
      #       if [ -n "$SUBMISSION_ID" ]; then
      #         echo "Fetching notarization log..."
      #         xcrun notarytool log "$SUBMISSION_ID" \
      #           --apple-id "$APPLE_ID" \
      #           --password "$APPLE_PASSWORD" \
      #           --team-id "$APPLE_TEAM_ID"
      #       fi
            
      #       exit 1
      #     fi

      # Generate build summary
      - name: Generate Build Summary
        if: always()
        env:
          DMG_NOTARIZED: ${{ steps.notarize-dmg.outputs.notarized }}
          PKG_NOTARIZED: ${{ steps.notarize-pkg.outputs.notarized }}
        run: |
          echo "## macOS Release Build Summary (${{ matrix.name-suffix }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Signing | ✅ Enabled |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DMG_NOTARIZED" = "true" ]; then
            echo "| DMG Notarization | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| DMG Notarization | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$PKG_NOTARIZED" = "true" ]; then
            echo "| PKG Notarization | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PKG Notarization | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

      # Cleanup keychain
      - name: Cleanup Keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security delete-keychain $KEYCHAIN_PATH || true
          rm -f $RUNNER_TEMP/certificate.p12 || true
          rm -f $RUNNER_TEMP/installer_certificate.p12 || true

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: dist/*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # jpackage only supports up to 3 version segments (x.y.z)
          APP_VERSION=$(echo $VERSION | cut -d. -f1-3)
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build JAR
        run: mvn clean package -Pdesktop -DskipTests "-Djavafx.platform=linux"

      - name: Create DEB Package
        run: |
          jpackage \
            --input target \
            --name keenotes \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type deb \
            --app-version ${{ steps.version.outputs.app_version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/icon-512.png" \
            --java-options "-Xmx512m" \
            --linux-shortcut \
            --dest dist

      - name: Create RPM Package
        run: |
          jpackage \
            --input target \
            --name keenotes \
            --main-jar keenotes-mobile-1.0.0-SNAPSHOT.jar \
            --main-class org.springframework.boot.loader.launch.JarLauncher \
            --type rpm \
            --app-version ${{ steps.version.outputs.app_version }} \
            --vendor "Keevol" \
            --icon "src/main/resources/icons/icon-512.png" \
            --java-options "-Xmx512m" \
            --linux-shortcut \
            --dest dist

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: dist/*

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            VERSION="${VERSION#V}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Generate versionCode from version (e.g., 1.2.3 -> 10203)
          VERSION_CODE=$(echo $VERSION | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.13'

      # Decode keystore from secrets
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ${{ github.workspace }}/keystore.jks

      # Build signed Release APK
      - name: Build Signed Release APK
        working-directory: keenotes-android
        run: |
          gradle assembleRelease --no-daemon \
            -PKEYSTORE_FILE=${{ github.workspace }}/keystore.jks \
            -PKEYSTORE_PASSWORD="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -PKEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}" \
            -PKEY_PASSWORD="${{ secrets.ANDROID_KEY_PASSWORD }}" \
            -PversionName=${{ steps.version.outputs.version }} \
            -PversionCode=${{ steps.version.outputs.versionCode }}

      # Build signed Release AAB (for Google Play)
      - name: Build Signed Release AAB
        working-directory: keenotes-android
        run: |
          gradle bundleRelease --no-daemon \
            -PKEYSTORE_FILE=${{ github.workspace }}/keystore.jks \
            -PKEYSTORE_PASSWORD="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -PKEY_ALIAS="${{ secrets.ANDROID_KEY_ALIAS }}" \
            -PKEY_PASSWORD="${{ secrets.ANDROID_KEY_PASSWORD }}" \
            -PversionName=${{ steps.version.outputs.version }} \
            -PversionCode=${{ steps.version.outputs.versionCode }}

      # Cleanup keystore for security
      - name: Cleanup Keystore
        if: always()
        run: rm -f ${{ github.workspace }}/keystore.jks

      # Upload APK
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: keenotes-android/app/build/outputs/apk/release/*.apk

      # Upload AAB
      - name: Upload Android AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: keenotes-android/app/build/outputs/bundle/release/*.aab

  # build-ios:
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Extract version
  #       id: version
  #       run: |
  #         if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
  #           VERSION="${{ github.event.inputs.version }}"
  #         else
  #           VERSION="${GITHUB_REF_NAME#v}"
  #           VERSION="${VERSION#V}"
  #         fi
  #         echo "version=$VERSION" >> $GITHUB_OUTPUT

  #     - name: Select Xcode version
  #       run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

  #     - name: Resolve Swift Package Dependencies
  #       working-directory: keenotes-ios
  #       run: xcodebuild -resolvePackageDependencies -project KeeNotes.xcodeproj -scheme KeeNotes

  #     - name: Build Release Archive
  #       working-directory: keenotes-ios
  #       run: |
  #         xcodebuild archive \
  #           -project KeeNotes.xcodeproj \
  #           -scheme KeeNotes \
  #           -destination 'generic/platform=iOS' \
  #           -archivePath build/KeeNotes.xcarchive \
  #           -configuration Release \
  #           CODE_SIGN_IDENTITY="" \
  #           CODE_SIGNING_REQUIRED=NO \
  #           CODE_SIGNING_ALLOWED=NO \
  #           SKIP_INSTALL=NO \
  #           MARKETING_VERSION=${{ steps.version.outputs.version }}

  #     - name: Create unsigned IPA
  #       working-directory: keenotes-ios
  #       run: |
  #         mkdir -p build/Payload
  #         cp -r build/KeeNotes.xcarchive/Products/Applications/KeeNotes.app build/Payload/
  #         cd build && zip -r KeeNotes-${{ steps.version.outputs.version }}-unsigned.ipa Payload

  #     - name: Upload iOS Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-ipa
  #         path: keenotes-ios/build/*.ipa

  release:
    needs: [build-windows, build-macos, build-linux, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: KeeNotes ${{ env.VERSION }}
          tag_name: ${{ github.ref_name }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          generate_release_notes: true
          files: |
            artifacts/windows-installers/*
            artifacts/macos-mac/*
            artifacts/macos-mac-aarch64/*
            artifacts/linux-packages/*
            artifacts/android-apk/*
            artifacts/android-aab/*
            # artifacts/ios-ipa/*
