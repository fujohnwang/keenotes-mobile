name: Android Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 恢复使用 Java 21 (为了能编译你的 Java 21 代码)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 2. 安装 Gluon GraalVM
      - name: Install Gluon GraalVM
        run: |
          DOWNLOAD_URL="https://github.com/gluonhq/graal/releases/download/gluon-23%2B25.1-dev-2409082136/graalvm-java23-linux-amd64-gluon-23+25.1-dev.tar.gz"
          wget -q -O gluon-graalvm.tar.gz $DOWNLOAD_URL
          mkdir -p gluon-gvm
          tar -xzf gluon-graalvm.tar.gz -C gluon-gvm --strip-components=1
          echo "GRAALVM_HOME=$PWD/gluon-gvm" >> $GITHUB_ENV

      # 3. 构建 APK (只构建APK，不构建AAB)
      - name: Build APK
        env:
          # 直接引用 GitHub Action 环境自带的 Android SDK 路径变量
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          echo "Using Android SDK at: $ANDROID_SDK_ROOT"
          echo "Building Android APK..."
          
          # 只用 gluonfx:build，不用 gluonfx:package（后者会尝试构建AAB）
          # APK 会在 build 阶段生成
          mvn -Pandroid clean gluonfx:build \
            -Dgluonfx.target.android.sdk=$ANDROID_SDK_ROOT \
            -Dgluonfx.verbose=true \
            -X \
            -e
          
          # 手动运行 assembleDebug 只生成 APK
          if [ -d "target/gluonfx/aarch64-android/gvm/android_project" ]; then
            cd target/gluonfx/aarch64-android/gvm/android_project
            ./gradlew assembleDebug
            cd -
          fi

      # 4. 容错打印日志
      # 加了 if 判断，只有当目录存在时才打印，防止报错干扰判断
      - name: Print Gluon Error Logs
        if: failure()
        run: |
          if [ -d "target/gluonfx" ]; then
            echo "Finding log files..."
            find target/gluonfx -name "*.log" -exec echo "================ {} ================" \; -exec cat {} \;
          else
            echo "target/gluonfx directory does not exist. The build failed before Gluon could start."
            echo "Please check the 'Build APK' step logs directly."
          fi

      # 5. 列出构建产物
      - name: List build artifacts
        run: |
          echo "Listing target directory structure..."
          find target -name "*.apk" 2>/dev/null || echo "No APK files found"
          echo "Full target/gluonfx structure:"
          ls -la target/gluonfx/ 2>/dev/null || echo "target/gluonfx not found"
          if [ -d "target/gluonfx" ]; then
            find target/gluonfx -type f -name "*.apk"
          fi

      # 6. 上传APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: keenotes-android-apk
          path: |
            target/gluonfx/**/*.apk
          if-no-files-found: warn