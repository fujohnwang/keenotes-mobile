name: Android Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 直接安装 GraalVM 环境
      # 既然插件已经升级到 1.0.28，现在可以安全地使用 GraalVM 21 了，不会再报 CAPCache 错
      - name: Setup GraalVM
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      # 2. ⚡️ 核心修正：强制绑定 GRAALVM_HOME
      # Gluon 插件死板地寻找 GRAALVM_HOME 变量，而 setup-java 设置的是 JAVA_HOME
      # 这一步将它们打通
      - name: Set GRAALVM_HOME
        run: |
          echo "GRAALVM_HOME=$JAVA_HOME" >> $GITHUB_ENV

      # 3. 缓存 Maven 和 Gluon
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gluon
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      # 4. 执行构建
      # 加上 -e 显示详细错误
      - name: Build APK
        run: mvn -Pandroid clean gluonfx:build gluonfx:package -e

      # 5. 上传产物
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: keenotes-android-apk
          path: target/gluonfx/aarch64-android/**/*.apk
          retention-days: 5