name: Android Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. åŸºç¡€ç¯å¢ƒï¼šJava 21
      # æ—¢ç„¶ç”¨æœ€æ–°ç‰ˆï¼Œæˆ‘ä»¬å…¨çº¿ç»Ÿä¸€ç”¨ Java 21
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 2. æ ¸å¿ƒæ­¥éª¤ï¼šä¸‹è½½å¹¶é…ç½® Gluon ä¸“ç”¨ GraalVM
      # è¯·åŠ¡å¿…ç¡®ä¿ä¸‹è½½çš„æ˜¯ã€linux-amd64ã€‘æˆ–ã€linux-x64ã€‘ç‰ˆæœ¬ï¼Œä¸è¦ä¸‹è½½ aarch64ï¼
      - name: Install Gluon GraalVM
        run: |
          # ğŸ‘‡ğŸ‘‡ğŸ‘‡ åœ¨è¿™é‡Œå¡«å…¥ä½ æ‰¾åˆ°çš„æœ€æ–°ç‰ˆ Gluon GraalVM ä¸‹è½½é“¾æ¥ ğŸ‘‡ğŸ‘‡ğŸ‘‡
          # æ³¨æ„ï¼šå¿…é¡»æ˜¯ Linux x64/AMD64 ç‰ˆæœ¬ (å› ä¸º GitHub Runner æ˜¯ Intel èŠ¯ç‰‡)
          DOWNLOAD_URL="https://github.com/gluonhq/graal/releases/download/gluon-23%2B25.1-dev-2409082136/graalvm-java23-linux-amd64-gluon-23+25.1-dev.tar.gz"
          
          # ä¸‹è½½
          wget -q -O gluon-graalvm.tar.gz $DOWNLOAD_URL
          
          # è§£å‹
          mkdir -p gluon-gvm
          tar -xzf gluon-graalvm.tar.gz -C gluon-gvm --strip-components=1
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "GRAALVM_HOME=$PWD/gluon-gvm" >> $GITHUB_ENV

      # 3. æ„å»º
      # æ’ä»¶ 1.0.28 + æœ€æ–° Gluon GraalVM = æˆåŠŸ
      - name: Build APK
        run: mvn -Pandroid clean gluonfx:build gluonfx:package
      
      # 4. ä¸Šä¼ 
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: keenotes-android-apk
          path: target/gluonfx/aarch64-android/**/*.apk