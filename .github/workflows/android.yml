name: Android Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 恢复使用 Java 21 (为了能编译你的 Java 21 代码)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 2. 安装 Gluon GraalVM
      - name: Install Gluon GraalVM
        run: |
          DOWNLOAD_URL="https://github.com/gluonhq/graal/releases/download/gluon-23%2B25.1-dev-2409082136/graalvm-java23-linux-amd64-gluon-23+25.1-dev.tar.gz"
          wget -q -O gluon-graalvm.tar.gz $DOWNLOAD_URL
          mkdir -p gluon-gvm
          tar -xzf gluon-graalvm.tar.gz -C gluon-gvm --strip-components=1
          echo "GRAALVM_HOME=$PWD/gluon-gvm" >> $GITHUB_ENV

      # 3. 构建 APK
      - name: Build APK
        env:
          # 直接引用 GitHub Action 环境自带的 Android SDK 路径变量
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          echo "Using Android SDK at: $ANDROID_SDK_ROOT"
          echo "Building with enhanced Android debugging..."
          
          # 关键技巧：
          # 虽然我们用 Java 21 运行 Maven，但我们强制 Gradle 使用 Java 17 (如果系统里有的话) 
          # 或者我们直接尝试用 Java 21 跑。
          # 如果之前是因为下载 SDK 失败，这次指定了 SDK 路径应该能跳过下载。
          
          mvn -Pandroid clean gluonfx:build gluonfx:package \
            -Dgluonfx.target.android.sdk=$ANDROID_SDK_ROOT \
            -Dgluonfx.verbose=true \
            -X \
            -e

      # 4. 容错打印日志
      # 加了 if 判断，只有当目录存在时才打印，防止报错干扰判断
      - name: Print Gluon Error Logs
        if: failure()
        run: |
          if [ -d "target/gluonfx" ]; then
            echo "Finding log files..."
            find target/gluonfx -name "*.log" -exec echo "================ {} ================" \; -exec cat {} \;
          else
            echo "target/gluonfx directory does not exist. The build failed before Gluon could start."
            echo "Please check the 'Build APK' step logs directly."
          fi

      # 5. 列出构建产物
      - name: List build artifacts
        run: |
          echo "Listing target directory structure..."
          find target -name "*.apk" -o -name "*.aab" 2>/dev/null || echo "No APK/AAB files found"
          echo "Full target/gluonfx structure:"
          ls -la target/gluonfx/ 2>/dev/null || echo "target/gluonfx not found"
          if [ -d "target/gluonfx" ]; then
            find target/gluonfx -type f -name "*.apk" -o -name "*.aab"
          fi

      # 6. 上传APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: keenotes-android-apk
          path: |
            target/gluonfx/**/*.apk
            target/gluonfx/**/*.aab
          if-no-files-found: warn