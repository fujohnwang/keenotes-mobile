name: Android Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest # 确保使用最新版 x64 环境

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 改回 Java 17
      # 原因：Android Gradle 插件对 Java 21 的支持可能存在版本匹配问题，17 是目前最稳的。
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 2. 安装 Gluon GraalVM (Linux AMD64)
      - name: Install Gluon GraalVM
        run: |
          DOWNLOAD_URL="https://github.com/gluonhq/graal/releases/download/gluon-23%2B25.1-dev-2409082136/graalvm-java23-linux-amd64-gluon-23+25.1-dev.tar.gz"
          wget -q -O gluon-graalvm.tar.gz $DOWNLOAD_URL
          mkdir -p gluon-gvm
          tar -xzf gluon-graalvm.tar.gz -C gluon-gvm --strip-components=1
          echo "GRAALVM_HOME=$PWD/gluon-gvm" >> $GITHUB_ENV

      # 3. 构建 APK
      # 关键修改：增加 -Dgluonfx.target.android.sdk 指定使用系统自带 SDK
      - name: Build APK
        env:
          # GitHub Actions 的 ubuntu-latest 自带了 Android SDK，路径通常在这里
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          mvn -Pandroid clean gluonfx:build gluonfx:package \
            -Dgluonfx.target.android.sdk=$ANDROID_SDK_ROOT

      # 4. 【调试关键】如果构建失败，打印 Gluon 的详细日志文件
      # 如果这步不加，你永远不知道为什么 package-task 失败
      - name: Print Gluon Error Logs
        if: failure()
        run: |
          echo "Finding log files..."
          find target/gluonfx -name "*.log"
          echo "Printing log contents:"
          find target/gluonfx -name "*.log" -exec echo "================ {} ================" \; -exec cat {} \;

      # 5. 上传
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: keenotes-android-apk
          path: target/gluonfx/aarch64-android/**/*.apk